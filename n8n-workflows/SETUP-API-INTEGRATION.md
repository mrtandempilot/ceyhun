# ğŸ« Payment Automation with Your Ticket API - Setup Guide

## What's Different?

This workflow uses **your existing ticket system** instead of generating simple QR codes!

### Benefits:
âœ… Professional, branded tickets
âœ… Consistent with your app  
âœ… Centralized ticket generation
âœ… Better tracking via ticket_id in database

---

## ğŸ“¥ Step 1: Import the New Workflow

1. Open n8n
2. Click **"+"** â†’ **"Import from File"**
3. Select: `02-payment-automation-WITH-API.json`
4. Click **Import**

---

## âš™ï¸ Step 2: Update the Ticket API URL

The workflow needs to know where your ticket API is deployed!

1. Click on the **"Generate Ticket (Your API)"** node
2. Find the **URL** field that says: `https://YOUR-VERCEL-URL.vercel.app/api/tickets/generate`
3. Replace `YOUR-VERCEL-URL` with your actual Vercel URL

**Examples:**
- If your app is at: `https://ceyhun.vercel.app`
- Change URL to: `https://ceyhun.vercel.app/api/tickets/generate`

OR if testing locally:
- Use: `http://localhost:3000/api/tickets/generate`

---

## ğŸ”§ Step 3: How It Works

### Old Way (Simple QR):
Payment â†’ Update DB â†’ Generate QR Code â†’ Send WhatsApp

### New Way (Your API):
Payment â†’ Update DB â†’ **Call Your Ticket API** â†’ Send WhatsApp

---

## ğŸ¯ The New Node Explained

**"Generate Ticket (Your API)" Node:**

**What it does:**
- Calls your `/api/tickets/generate` endpoint
- Sends the booking_id
- Gets back complete ticket data including:
  - ticket_id (like "TICKET-abc-123-456")
  - customer details
  - tour information
  - qr_code_url
  
**What it sends:**
```json
{
  "booking_id": "c97c1e1e-f1c5-4000-8a6f-f1095ba0d6d3"
}
```

**What it receives:**
```json
{
  "ticket_id": "TICKET-abc-123-456",
  "customer_name": "John Doe",
  "tour_name": "Paragliding",
  "qr_code_url": "https://api.qrserver.com/...",
  // ... all other booking details
}
```

---

## ğŸ§ª Step 4: Test the Workflow

### Get a Real Booking ID:

```sql
SELECT id FROM public.bookings LIMIT 1;
```

### Test Command:

```cmd
curl -X POST https://mvt36n7e.rpcld.com/webhook-test/payment-received -H "Content-Type: application/json" -d "{\"body\":{\"payment_status\":\"succeeded\",\"booking_id\":\"YOUR-BOOKING-ID-HERE\",\"amount\":2000,\"payment_method\":\"cash\"}}"
```

### What Should Happen:

1. âœ… Payment Webhook receives data
2. âœ… Payment Successful? checks status
3. âœ… Get Booking Details from Supabase
4. âœ… Update Booking Status to "confirmed"
5. âœ… **Generate Ticket calls YOUR API** â† NEW!
6. âœ… Send WhatsApp with YOUR branded ticket
7. âœ… Notify Telegram with ticket_id
8. âœ… Return success response

---

## ğŸ” Verify It's Working

### Check Your Database:

```sql
SELECT id, ticket_id, status 
FROM public.bookings 
WHERE id = 'YOUR-BOOKING-ID';
```

You should see:
- `status` = "confirmed"
- `ticket_id` = "TICKET-..." (generated by your API)

### Check WhatsApp:
Customer receives ticket with YOUR QR code format

### Check Telegram:
You get notification with the proper ticket_id

---

## ğŸ†š Comparison

### Old Workflow (FREE version):
- âŒ Simple QR code only
- âŒ Basic ticket format
- âŒ No ticket_id tracking
- âœ… Works independently

### New Workflow (API version):
- âœ… Professional ticket from your system
- âœ… Proper ticket_id in database
- âœ… Consistent with your app
- âœ… Better customer experience
- âš ï¸ Requires your app to be deployed

---

## âš ï¸ Important Notes

### 1. Your API Must Be Accessible

Make sure your Vercel app is deployed and the `/api/tickets/generate` endpoint is working!

**Test it manually first:**
```bash
curl -X POST https://YOUR-APP.vercel.app/api/tickets/generate \
  -H "Content-Type: application/json" \
  -d '{"booking_id":"YOUR-BOOKING-ID"}'
```

If this works, the workflow will work!

### 2. For Local Testing

If testing locally before deployment:
1. Run your Next.js app: `npm run dev`
2. Change the workflow URL to: `http://localhost:3000/api/tickets/generate`
3. Make sure n8n can reach localhost (might need ngrok for cloud n8n)

### 3. Error Handling

If your API fails:
- Check n8n execution logs
- Verify the API URL is correct
- Make sure Supabase credentials in your app are valid
- Check Vercel deployment logs

---

## ğŸš€ Production Deployment

### Before Going Live:

1. âœ… Test locally with your API
2. âœ… Deploy your app to Vercel
3. âœ… Update workflow with production URL
4. âœ… Test with real booking
5. âœ… Activate the workflow in n8n

---

## ğŸ’¡ Recommendation

**Use this API-integrated version** because:
- More professional
- Better tracking
- Consistent branding
- Centralizes ticket logic
- Only slightly more complex to set up

The only thing you need to change is **ONE URL** in the workflow - that's it! ğŸ¯

---

## ğŸ“ Next Steps

1. Import the workflow
2. Update the API URL to your Vercel app
3. Test with a real booking ID
4. Activate and enjoy automated professional tickets!

**Your customers will love the consistent, professional experience!** âœ¨
